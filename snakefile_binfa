SAMPLES=["A", "B"]

rule all:
	input:
		seqs="results/dada2/seqTab.collapsed.RDS", # Chimera-free sequence table
		refFasta="resources/silva_nr99_v138.1_train_set.fa.gz"
	output:
		"results/dada2/taxa.RDS" # Taxonomic assignments

rule fastqc:
	input:
		expand("reads/{sample}.fastq", sample=SAMPLES)
		#TO DO: przerobic tak, zeby przetwarzalo od razu caly batch(folder) probek, a nie kazda z osobna
	output:
		html="qc/fastqc/{sample}.html",
		zip="qc/fastqc/{sample}_fastqc.zip" # IMPORTANT: the suffix _fastqc.zip is necessary for multiqc to find the file.
	params: "--quiet"
	log:
		"logs/fastqc/{sample}.log"
	threads: 1
	wrapper:
		"0.80.2/bio/fastqc"

rule multiqc:
	input:
		expand("fastqc/{sample}_fastqc.zip", sample=SAMPLES)
	output:
		"qc/multiqc.html"
	params:
		""  # Optional: extra parameters for multiqc.
	log:
		"logs/multiqc.log"
	wrapper:
		"0.80.2/bio/multiqc"

rule trimmomatic:
	input:
		expand("reads/{sample}.fastq", sample=SAMPLES)  #TO DO: to samo, co w przypadku fastqc
	output:
		"trimmed/{sample}.1.fastq"
	log:
		"logs/trimmomatic/{sample}.1.log"
	params:
		# list of trimmers (see manual)
		trimmer=["TRAILING:3"],
		# optional parameters
		extra="",
		# optional compression levels from -0 to -9 and -11
		compression_level="-9"
	threads:
		32
	# optional specification of memory usage of the JVM that snakemake will respect with global
	# resource restrictions (https://snakemake.readthedocs.io/en/latest/snakefiles/rules.html#resources)
	# and which can be used to request RAM during cluster job submission as `{resources.mem_mb}`:
	# https://snakemake.readthedocs.io/en/latest/executing/cluster.html#job-properties
	resources:
		mem_mb=1024 #hmmmmmmmm
	wrapper:
		"0.80.2/bio/trimmomatic/se"

rule dada2_learn_errors:
	input:
	# Quality filtered and trimmed forward FASTQ files (potentially compressed)
		expand("trimmed/{sample}.{orientation}.fastq", sample=SAMPLES, orientation=1)
	output:
		err="results/dada2/model_{orientation}.RDS",# save the error model
		plot="reports/dada2/errors_{orientation}.png",# plot observed and estimated rates
	params:
		randomize=True
	log:
		"logs/dada2/learn-errors/learn-errors_{orientation}.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/learn-errors"

rule dada2_dereplicate_fastq:
	input:
	# Quality filtered FASTQ file
		expand("trimmed/{sample}.{orientation}.fastq", sample=SAMPLES, orientation=1)
	output:
	# Dereplicated sequences stored as `derep-class` object in a RDS file
		"uniques/{sample}.RDS"
	log:
		"logs/dada2/dereplicate-fastq/{sample}.log"
	wrapper:
		"0.80.2/bio/dada2/dereplicate-fastq"

rule dada2_sample_inference:
	input:
	# Dereplicated (aka unique) sequences of the sample
		derep=expand("uniques/{sample}.{orientation}.RDS", sample=SAMPLES, orientation=1),
		err="results/dada2/model_{orientation}.RDS" # Error model
	output:
		"denoised/{sample}.{orientation}.RDS" # Inferred sample composition
	log:
		"logs/dada2/sample-inference/{sample}.{orientation}.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/sample-inference"

rule dada2_make_table_se:
	input:
	# Inferred composition
		expand("denoised/{sample}.1.RDS", sample=SAMPLES)
	output:
		"results/dada2/seqTab-se.RDS"
	params:
		names=['a','b'] # Sample names instead of paths
	log:
		"logs/dada2/make-table/make-table-se.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/make-table"

rule dada2_remove_chimeras:
	input:
		"results/dada2/seqTab-se.RDS" # Sequence table
	output:
		"results/dada2/seqTab.nochimeras.RDS" # Chimera-free sequence table
	log:
		"logs/dada2/remove-chimeras/remove-chimeras.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/remove-chimeras"

rule dada2_collapse_nomismatch:
	input:
		"results/dada2/seqTab.nochimeras.RDS" # Chimera-free sequence table
	output:
		"results/dada2/seqTab.collapsed.RDS"
	log:
		"logs/dada2/collapse-nomismatch/collapse-nomismatch.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/collapse-nomismatch"

rule dada2_assign_taxonomy:
	input:
		seqs="results/dada2/seqTab.collapsed.RDS", # Chimera-free sequence table
		refFasta="resources/silva_nr99_v138.1_train_set.fa.gz" # Reference FASTA for taxonomy (trzeba bedzie pobrac odpowiedni plik stad:https://zenodo.org/record/4587955)
	output:
		"results/dada2/taxa.RDS" # Taxonomic assignments
	log:
		"logs/dada2/assign-taxonomy/assign-taxonomy.log"
	threads: 1 # set desired number of threads here
	wrapper:
		"0.80.2/bio/dada2/assign-taxonomy"
